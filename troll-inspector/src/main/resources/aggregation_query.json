{
  "size": 0,
  "aggs": {
    "position": {
      "terms": {
        "field": "lane.keyword",
        "size": 6
      },
      "aggs": {
        "KDA_score": {
          "scripted_metric": {
            "init_script": "state.scores = []",
            "map_script": "String lane = doc['lane.keyword'].value;\ndouble kdaScore = (doc['kills'].value + doc['assists'].value) / (doc['deaths'].value + 1);\ndouble killParticipationScore = doc['killParticipation'].value * 100;\nlong wardsPlaced = (doc['stealthWardsPlaced'].value + doc['controlWardsPlaced'].value);\nif(lane == 'NONE') {\nint index = doc['targetIndex'].value.intValue();\nString[] arr = new String[]{'TOP', 'JUNGLE', 'MIDDLE', 'BOTTOM', 'SUPPORT'};\nlane = arr[index % 5];\n}if (wardsPlaced >= 20 || lane == 'SUPPORT') {\ndouble wardsScore = ((double) wardsPlaced * 0.5) + ((double) doc['detectorWardsPlaced'].value * 0.5);\ndouble sptLanerScore = kdaScore + killParticipationScore + wardsScore;\nstate.scores.add(sptLanerScore);\n}else if (lane == 'TOP') {\ndouble towerDamageScore = doc['damageDealtToBuildings'].value / 1000;\ndouble championDamageScore = (doc['physicalDamageDealtToChampions'].value + doc['magicDamageDealtToChampions'].value) / 1000;\ndouble topLanerScore = kdaScore + killParticipationScore + towerDamageScore + championDamageScore;state.scores.add(topLanerScore);} else if (lane == 'JUNGLE') {double dragonBaronScore = (doc['dragonTakedowns'].value + doc['baronTakedowns'].value) * 10;double wardTakedownScore = doc['wardTakedowns'].value * 5;double junglerScore = kdaScore + killParticipationScore + dragonBaronScore + wardTakedownScore;state.scores.add(junglerScore);} else if (lane == 'MIDDLE') {double championDamageScore = (doc['physicalDamageDealtToChampions'].value + doc['magicDamageDealtToChampions'].value) / 1000;double roamingKills = doc['teleportTakedowns'].value * 10;double midLanerScore = kdaScore + killParticipationScore + championDamageScore + roamingKills;state.scores.add(midLanerScore);} else if (lane == 'BOTTOM') {double championDamageScore = (doc['physicalDamageDealtToChampions'].value + doc['magicDamageDealtToChampions'].value) / 1000;double totalMinionsKilled = doc['totalMinionsKilled'].value / 10;\ndouble adcLanerScore = kdaScore + killParticipationScore + championDamageScore + totalMinionsKilled;\nstate.scores.add(adcLanerScore);\n}",
            "combine_script": "double totalScore = 0;\nfor (double score : state.scores) {\n    totalScore += score;\n}\nMap result = new HashMap();\nresult.put(\"totalScore\", totalScore);\nresult.put(\"count\", state.scores.size());\nreturn result;",
            "reduce_script": "Map result = new HashMap();\ndouble grandTotalScore = 0;\nlong grandTotalCount = 0;\n\nfor (Map shard : states) {\n    grandTotalScore += (double) shard.get(\"totalScore\");\n    grandTotalCount += (long) shard.get(\"count\");\n}\ndouble finalScore = grandTotalCount > 0 ? (grandTotalScore / grandTotalCount) : 0;\nresult.put(\"finalScore\", finalScore);\nresult.put(\"totalScore\", grandTotalScore);\nresult.put(\"count\", grandTotalCount);\nreturn result;"
          }
        }
      }
    }
  }
}